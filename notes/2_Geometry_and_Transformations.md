---
title: "2 几何和变换"
author: "ja50n"
date: "2022-08-23"
---

几何指的是基础几何，即光追模型里的点、向量、光线等等，而不是图形绘制的场景几何。

# 1 坐标系

在一个原点和一组（不相关的）向量基底下，使用一组标量可以唯一表示一个点。为了避免无穷的相对依赖，使用原点 $(0, 0, 0)$ 和基底 $(1, 0, 0)$、$(0, 1, 0)$ 和 $(0, 0, 1)$ 作为绝对的世界空间，其他坐标 frame 都直接或间接基于它。

## 1.1 手性

左右手性的选择是任意的，但是确定后的许多几何操作都隐式依赖于它。`pbrt` 使用左手系。

# 2 向量

`pbrt` 提供二维和三维向量，使用模板实现。

实现代码里的 `#ifndef NDEBUG` 是在调试状态下启用自定义的带 assert 的拷贝和复制重载，其他情况下直接使用自动生成的对应函数。

向量要实现的功能主要是运算、相等判断和模长，另外有重载下标符号来实现取分量的拷贝或者引用（便于循环遍历）、重载输出流等等。注意在必要的时候（所有运算）检查 NaN。

可以用模板来指定维数，但是访问的时候就没法用直观的字母来表示。

另外可以从模板定义几个常用的确定类型，比如 `using Vector2d = Vector2<oduble>`。

可见性上，使用 private 没有什么收益，还会增加访问的代码量，所以全部暴露出来就好。

项目的 assertion 机制需要注意。

基于单个向量构造局部坐标系有多种策略。pbrt 假设传入的向量已经归一化，然后通过

1. 抹去 x 和 y 轴上较小的分量
2. 交换剩余的两个分量并将其中一个变号
3. 归一化

来构造第二个分量。第三个分量为之前两个的叉积。

叉积是被限定在坐标系里的，因此不能看出坐标系的手性。

# 3 点

点的结构和实现都类似于向量，但实际的意义不同。

需要提供一些特殊的转换，例如从浮点到整数、从向量到点或从点到向量。这些转换都应该用 `explicit` 指明。

由于是两个不同的类型，数学上可以互操作的特性也要一一实现，比如将一个点沿一个向量平移、点点相减得向量等。

> 点和向量的数据都用一个独立类型代替如何，比如矩阵？由这个组合进去的类型负责实现通用的运算，再用“向量”、“点”这些概念去控制特殊运算。尽管还是要挨个实现重载，但运算细节只需要实现一次。

一些点独有的运算，比如两点的构成的 AABB 中取最小/最大顶点、上下取整、取绝对值等等。

# 4 法向量

法向量也是向量，但其附属于特定的平面，在“某些场合下”行为与向量不同，比如对线性变换的反应、不能与点相加、不能叉积等等。注意法向量不一定是归一化的。

法向量和普通三维向量的互相转换，由于不是常规操作，需要用 `explicit` 指明，避免允许赋值行为。

不能叉积，但是要支持点积运算，又多一点代码。

法向量比较特殊的一个操作，是反转方向。这个经常被用来保证法向量总是顺着光线方向，而另外记录法向量和它附属平面的关系。

# 5 光线


